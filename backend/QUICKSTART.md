# Backend - Quick Reference Guide

---

## ðŸš€ Quick Start

### Automated Startup (Recommended)
```powershell
# Windows PowerShell
cd backend
python app_gcp.py
```

### Manual Setup
```powershell
# 1. Create virtual environment
cd backend
python -m venv venv

# 2. Activate virtual environment
.\venv\Scripts\Activate.ps1  # Windows
source venv/bin/activate      # Linux/macOS

# 3. Install dependencies
pip install -r requirements.txt

# 4. Start service
python app_gcp.py
```

**Service URL**: http://localhost:8000

---

## ðŸ“‹ Prerequisites Checklist

- âœ… **Python 3.10+** installed
- âœ… **Java 8 or 11** installed (for PySpark)
- âœ… **Trained models** available in `../output/` directory
- âœ… **8GB+ RAM** recommended

### Quick Java Check
```powershell
# Check Java version
java -version

# If not installed, download from:
# https://adoptium.net/
```

---

## ðŸ§ª Testing

### Run All Tests
```powershell
cd backend
python test_backend.py
```

**Expected Output**:
```
Testing health endpoint...
âœ“ Health check passed

Testing prediction endpoint...
âœ“ Prediction successful: max=$118.50, min=$45.20

All tests passed! âœ¨
```

### Quick API Tests
```bash
# Health check
curl http://localhost:8000/api/health

# Model info
curl http://localhost:8000/api/model-info

# Prediction test
curl -X POST http://localhost:8000/api/predict \
  -H "Content-Type: application/json" \
  -d '{"artist":"Taylor Swift","city":"New York","state":"NY","date":"2024-06-15","genre":"Pop"}'
```

---

## ðŸŽ¯ API Endpoints

| Endpoint | Method | Purpose | Response Time |
|----------|--------|---------|---------------|
| `/` | GET | API info | <50ms |
| `/api/health` | GET | Health check | <100ms |
| `/api/model-info` | GET | Model metadata | <200ms |
| `/api/predict` | POST | Price prediction | 500ms-2s |

### Interactive Documentation
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

---

## ðŸ’¡ Example Usage

### Simple Prediction Request
```json
POST http://localhost:8000/api/predict

{
  "artist": "Ed Sheeran",
  "city": "Los Angeles",
  "state": "CA",
  "date": "2024-08-20",
  "genre": "Pop"
}
```

### Response
```json
{
  "prediction": {
    "max_price": 128.50,
    "min_price": 52.30,
    "price_range": 76.20,
    "confidence": "high"
  },
  "input_features": {
    "artist": "Ed Sheeran",
    "city": "Los Angeles",
    "spotify_popularity": 92,
    "year": 2024,
    "month": 8,
    ...
  }
}
```

---

## âš¡ Performance

### Startup Time
- **First Launch**: 30-60 seconds (Spark initialization)
- **Subsequent Launches**: 10-15 seconds

### Prediction Latency
- **First Prediction**: 2-5 seconds (lazy loading)
- **Subsequent Predictions**: 500ms - 2 seconds
- **Throughput**: 30-60 requests/minute

### Memory Usage
- **Idle**: 500MB - 1GB
- **Active**: 1-2GB
- **Peak**: 2-4GB

---

## ðŸ”§ Common Issues & Solutions

### Issue: "Java not found"
```powershell
# Install Java 11 from https://adoptium.net/
# Then set environment variable:
$env:JAVA_HOME = "C:\Program Files\Eclipse Adoptium\jdk-11.0.x.x-hotspot"
$env:PATH = "$env:JAVA_HOME\bin;$env:PATH"

# Verify
java -version
```

---

### Issue: "Model files not found"
```powershell
# Check if models exist
ls ..\output\ml_multi_models_max\models\random_forest

# If missing, train models first
cd ..\training
python run_master_pipeline.py --mode local
```

---

### Issue: "Port 8000 already in use"
```powershell
# Find process using port 8000
netstat -ano | findstr :8000

# Kill process (replace <PID> with actual process ID)
taskkill /PID <PID> /F

# Alternative: Use different port
python app_gcp.py --port 8001
```

---

### Issue: "Slow first prediction"
**This is normal!** Spark uses lazy initialization.
- First prediction: 2-5 seconds
- Subsequent predictions: <2 seconds

No action needed.

---

### Issue: "Out of memory"
```powershell
# Increase Spark driver memory
$env:SPARK_DRIVER_MEMORY = "4g"
python app_gcp.py
```

---

## ðŸ“‚ Project Files

```
backend/
â”œâ”€â”€ app_gcp.py              # Main FastAPI application
â”œâ”€â”€ predictor_gcp.py        # Spark ML prediction logic  
â”œâ”€â”€ requirements.txt        # Dependencies
â”œâ”€â”€ test_backend.py         # Test suite
â”œâ”€â”€ startup.py              # Startup utilities
â”œâ”€â”€ backend_url.txt         # Deployment URL
â”œâ”€â”€ QUICKSTART.md           # This file
â””â”€â”€ README.md               # Full documentation
```

---

## ðŸ“Š Required Model Files

The backend expects these files (generated by training pipeline):

```
../output/
â”œâ”€â”€ ml_multi_models_max/
â”‚   â””â”€â”€ models/
â”‚       â””â”€â”€ random_forest/      # MAX price model
â”œâ”€â”€ ml_multi_models_min/
â”‚   â””â”€â”€ models/
â”‚       â””â”€â”€ random_forest/      # MIN price model
â”œâ”€â”€ ml_results_max/
â”‚   â””â”€â”€ avg_encoding_max/       # Average encoding for MAX
â”œâ”€â”€ ml_results_min/
â”‚   â””â”€â”€ avg_encoding_min/       # Average encoding for MIN
â””â”€â”€ ...

../data/
â””â”€â”€ master_df.csv               # Artist reference data
```

---

## ðŸš€ Deployment Options

### Local Development
```powershell
python app_gcp.py
# Access at: http://localhost:8000
```

### Docker
```bash
docker build -t ticket-price-api .
docker run -p 8000:8000 ticket-price-api
```

### Google Cloud Run
```powershell
cd ..\deployment
.\deploy_to_gcp.ps1
```

See [GCP_DEPLOYMENT_GUIDE.md](../GCP_DEPLOYMENT_GUIDE.md) for details.

---

## ðŸ“– Documentation

- **ðŸ“˜ Full Backend Guide**: [README.md](README.md)
- **ðŸŽ¯ Training Pipeline**: [../training/](../training/)
- **ðŸŒ Frontend Integration**: [../frontend/](../frontend/)
- **â˜ï¸ GCP Deployment**: [../GCP_DEPLOYMENT_GUIDE.md](../GCP_DEPLOYMENT_GUIDE.md)
- **ðŸ“Š Output Files Guide**: [../OUTPUT_GUIDE.md](../OUTPUT_GUIDE.md)
- **ðŸ“š Main Project README**: [../README.md](../README.md)

---

## ðŸŽ“ Quick Commands Cheat Sheet

```powershell
# Setup
python -m venv venv
.\venv\Scripts\Activate.ps1
pip install -r requirements.txt

# Start server
python app_gcp.py

# Test
python test_backend.py

# Check health
curl http://localhost:8000/api/health

# Interactive docs
# Open http://localhost:8000/docs in browser

# Stop server
# Press Ctrl+C in terminal
```

---

## ðŸ’» Technology Stack

- **Web Framework**: FastAPI 0.104.1
- **ML Engine**: PySpark 3.1.2, Spark MLlib
- **Server**: Uvicorn (ASGI)
- **Data Validation**: Pydantic 2.5.0
- **Models**: RandomForest Regressor (Max & Min)

---

## ðŸ”— Related Resources

### Internal Docs
- Backend README: [README.md](README.md)
- Integration Guide: [../INTEGRATION_GUIDE.md](../INTEGRATION_GUIDE.md)
- Project Overview: [../README.md](../README.md)

### External Resources
- FastAPI Docs: https://fastapi.tiangolo.com/
- PySpark ML: https://spark.apache.org/docs/latest/ml-guide.html
- Uvicorn: https://www.uvicorn.org/

---

## ðŸ“ž Need Help?

1. **Check full documentation**: [README.md](README.md)
2. **Run tests**: `python test_backend.py`
3. **View logs**: Check terminal output for detailed error messages
4. **Common issues**: See troubleshooting section above

---

**Last Updated**: December 18, 2025  
**Version**: 1.0.0  
**Quick Reference for**: EECS 6893 Big Data Analysis Backend API
