<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Concert Ticket Pricing</title>
  <style>
    :root { --bg:#0b1020; --muted:#9aa7c7; --text:#eef2ff; --line:#22305e; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1000px 600px at 20% 0%, #182252 0%, transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, #2a165b 0%, transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 28px 18px 48px; }
    header { display:flex; gap:16px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    h1 { margin: 0; font-size: 22px; letter-spacing: .2px; }
    .sub { color: var(--muted); font-size: 13px; margin-top: 6px; max-width: 760px; }
    .grid { display:grid; grid-template-columns: 1.05fr .95fr; gap:16px; margin-top: 18px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      position: relative;
      overflow: hidden;
    }
    .card h2 { margin: 0 0 10px; font-size: 15px; color:#dbe3ff; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 12px 0 6px; }
    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline: none;
    }
    input:focus { border-color: rgba(124,58,237,.65); box-shadow: 0 0 0 4px rgba(124,58,237,.18); }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 520px){ .row{ grid-template-columns:1fr; } }

    .btn {
      margin-top: 14px;
      width: 100%;
      padding: 11px 12px;
      border: 0;
      border-radius: 12px;
      background: linear-gradient(90deg, #7c3aed, #4f46e5);
      color: white;
      font-weight: 650;
      cursor: pointer;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
    }
    .btn:disabled { opacity: .75; cursor: not-allowed; }

    /* Button spinner */
    .spinner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.35);
      border-top-color: rgba(255,255,255,.95);
      animation: spin 0.8s linear infinite;
      display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Card-level loading overlay (subtle, product-like) */
    .overlay {
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,.25));
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .overlay .pulse {
      width: 180px; height: 10px; border-radius: 999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .overlay .pulse::before {
      content:"";
      display:block;
      height:100%;
      width: 45%;
      background: linear-gradient(90deg, rgba(124,58,237,.0), rgba(124,58,237,.8), rgba(79,70,229,.0));
      animation: shimmer 1.1s ease-in-out infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-60%); }
      100% { transform: translateX(220%); }
    }

    .chipRow { display:flex; flex-wrap:wrap; gap:8px; margin-top: 8px; }
    .chip {
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: #dbe3ff;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      transition: transform .05s ease;
    }
    .chip:active { transform: translateY(1px); }

    .kpis { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 10px; }
    @media (max-width: 980px){ .kpis{ grid-template-columns:1fr; } }
    .kpi {
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 12px;
    }
    .kpi .t { font-size: 12px; color: var(--muted); }
    .kpi .v { font-size: 26px; margin-top: 6px; letter-spacing:.2px; }
    .kpi .s { font-size: 12px; color: #c7d2fe; margin-top: 4px; }

    .sectionTitle { margin-top: 14px; font-size: 12px; color: var(--muted); }
    .miniCard {
      margin-top: 8px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px 12px;
    }

    .bars { display:flex; flex-direction:column; gap:8px; margin-top: 8px; }
    .barRow { display:grid; grid-template-columns: 160px 1fr 52px; gap:10px; align-items:center; }
    @media (max-width: 520px){ .barRow{ grid-template-columns: 1fr; } }
    .barName { font-size: 12px; color:#dbe3ff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .barTrack { height: 10px; background: rgba(255,255,255,.08); border-radius: 999px; overflow:hidden; }
    .barFill { height: 100%; background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(79,70,229,.95)); width: 0%; }
    .barVal { font-size: 12px; color: var(--muted); text-align:right; }

    /* Range bar */
    .rangeWrap { margin-top: 10px; }
    .rangeMeta { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; color: var(--muted); font-size: 12px; }
    .rangeTrack {
      margin-top: 8px;
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      position: relative;
      overflow: hidden;
    }
    .rangeFill {
      position:absolute; top:0; height:100%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(124,58,237,.85), rgba(79,70,229,.85));
      left: 0%;
      width: 0%;
    }
    .rangeTicks {
      position:absolute; inset:0;
      background-image: linear-gradient(to right, rgba(255,255,255,.10) 1px, rgba(0,0,0,0) 1px);
      background-size: 20% 100%;
      opacity: .45;
      pointer-events:none;
    }
    .rangeLabelRow { display:flex; justify-content:space-between; font-size: 12px; color: #dbe3ff; margin-top: 8px; }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { padding: 8px 6px; border-bottom: 1px solid rgba(255,255,255,.08); vertical-align: top; }
    th { color: var(--muted); font-weight: 600; text-align:left; }
    td { color: #dbe3ff; }
    .smallMuted { color: var(--muted); font-size: 12px; }

    .log {
      margin-top: 10px;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      color: #cbd5ff;
      min-height: 64px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Concert Ticket Pricing</h1>
        <div class="sub">
          Given <b>artist popularity</b>, <b>location</b>, and <b>time</b>, we estimate <b>event occurrence probability</b>
          and predict the <b>primary-market</b> ticket price range (min/max).
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Input</h2>

        <div class="sectionTitle">Quick presets (one click)</div>
        <div class="chipRow" id="presets"></div>

        <label>Artist</label>
        <input id="artist" placeholder="e.g., Taylor Swift" value="Mannheim Steamroller Christmas" />

        <div class="row">
          <div>
            <label>City</label>
            <input id="city" placeholder="e.g., New York" value="Huntsville" />
          </div>
          <div>
            <label>State</label>
            <input id="state" placeholder="e.g., NY" value="AL" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>Genre (optional)</label>
            <input id="genre" placeholder="e.g., Pop / Rock" value="New Age" />
          </div>
        </div>

        <button class="btn" id="btn" onclick="onPredict()">
          <span class="spinner" id="btnSpin"></span>
          <span id="btnText">Predict</span>
        </button>
        <div class="log" id="log">Ready.</div>
      </div>

      <!-- RIGHT -->
      <div class="card" id="outCard">
        <div class="overlay" id="overlay">
          <div class="pulse"></div>
        </div>

        <h2>Output</h2>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Event Probability</div>
            <div class="v" id="prob"></div>
            <div class="s" id="probHint"></div>
          </div>
          <div class="kpi">
            <div class="t">Predicted Min Price</div>
            <div class="v" id="pmin"></div>
            <div class="s" id="rangeHint"></div>
          </div>
          <div class="kpi">
            <div class="t">Predicted Max Price</div>
            <div class="v" id="pmax"></div>
            <div class="s" id="maxHint"></div>
          </div>
        </div>

        <div class="sectionTitle">Price range (min - max)</div>
        <div class="miniCard rangeWrap">
          <div class="rangeMeta">
            <div id="rangeMetaLeft">Range: </div>
            <div id="rangeMetaRight">Scale: $0 - $500</div>
          </div>
          <div class="rangeTrack">
            <div class="rangeTicks"></div>
            <div class="rangeFill" id="rangeFill"></div>
          </div>
          <div class="rangeLabelRow">
            <div id="rangeMinLabel">Min: </div>
            <div id="rangeMaxLabel">Max: </div>
          </div>
        </div>

        <div class="sectionTitle">Model explanation (Top features)</div>
        <div class="miniCard">
          <div class="smallMuted">Higher bars indicate stronger contribution in this prediction.</div>
          <div class="bars" id="featBars"></div>
        </div>

        <div class="sectionTitle">Recent predictions (last 5)</div>
        <div class="miniCard">
          <table>
            <thead>
              <tr>
                <th style="width: 44%;">Query</th>
                <th style="width: 18%;">Prob</th>
                <th style="width: 19%;">Min</th>
                <th style="width: 19%;">Max</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <tr><td class="smallMuted" colspan="4">No history yet.</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://ticket-pricing-api-csei5odcva-uc.a.run.app/api/predict";
    const ALWAYS_FALLBACK_TO_LOCAL = true; // If backend fails, use local mock

    // Range bar scale (presentation-friendly)
    const RANGE_SCALE_MIN = 0;
    const RANGE_SCALE_MAX = 500;

    // ===== Helpers =====
    function fmtUSD(x) {
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "--";
      return "$" + Number(x).toFixed(0);
    }
    function fmtPct(x) {
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "--";
      return (Number(x) * 100).toFixed(1) + "%";
    }
    function clamp01(x) { return Math.max(0, Math.min(1, x)); }
    function setLog(msg) { document.getElementById("log").textContent = msg; }

    function setLoading(isLoading) {
      const btn = document.getElementById("btn");
      const spin = document.getElementById("btnSpin");
      const txt = document.getElementById("btnText");
      const overlay = document.getElementById("overlay");

      btn.disabled = isLoading;
      spin.style.display = isLoading ? "inline-block" : "none";
      txt.textContent = isLoading ? "Running..." : "Predict";
      overlay.style.display = isLoading ? "flex" : "none";
    }

    function getInputs() {
      const artist = document.getElementById("artist").value.trim();
      const city = document.getElementById("city").value.trim();
      const state = document.getElementById("state").value.trim();
      const date = document.getElementById("date").value;
      const genre = document.getElementById("genre").value.trim();
      if (!artist || !city || !state) throw new Error("Please fill in Artist, City, and State.");
      return { artist, city, state, date, genre };
    }

    // ===== Presets =====
    const PRESETS = [
      { label: "Taylor Swift · New York · NY", artist:"Taylor Swift", city:"New York", state:"NY", genre:"Pop" },
      { label: "Bad Bunny · Miami · FL", artist:"Bad Bunny", city:"Miami", state:"FL", genre:"Hip-Hop / Rap" },
      { label: "Drake · Los Angeles · CA", artist:"Drake", city:"Los Angeles", state:"CA", genre:"Hip-Hop / Rap" },
      { label: "Coldplay · Boston · MA", artist:"Coldplay", city:"Boston", state:"MA", genre:"Rock" },
      { label: "Mannheim Steamroller · Huntsville · AL", artist:"Mannheim Steamroller Christmas", city:"Huntsville", state:"AL", genre:"New Age" },
    ];

    function renderPresets() {
      const el = document.getElementById("presets");
      el.innerHTML = "";
      PRESETS.forEach(p => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = p.label;
        chip.onclick = () => {
          document.getElementById("artist").value = p.artist;
          document.getElementById("city").value = p.city;
          document.getElementById("state").value = p.state;
          document.getElementById("genre").value = p.genre;
          setLog("Preset filled. Click Predict.");
        };
        el.appendChild(chip);
      });
    }

    // ===== Explanation UI =====
    function renderFeatureBars(features) {
      const wrap = document.getElementById("featBars");
      wrap.innerHTML = "";
      if (!features || features.length === 0) {
        wrap.innerHTML = '<div class="smallMuted">No explanation available.</div>';
        return;
      }
      const maxVal = Math.max(...features.map(f => f.score), 1e-6);
      features.slice(0, 6).forEach(f => {
        const row = document.createElement("div");
        row.className = "barRow";

        const name = document.createElement("div");
        name.className = "barName";
        name.title = f.name;
        name.textContent = f.name;

        const track = document.createElement("div");
        track.className = "barTrack";
        const fill = document.createElement("div");
        fill.className = "barFill";
        const pct = Math.max(2, Math.round((f.score / maxVal) * 100));
        fill.style.width = pct + "%";
        track.appendChild(fill);

        const val = document.createElement("div");
        val.className = "barVal";
        val.textContent = f.score.toFixed(2);

        row.appendChild(name);
        row.appendChild(track);
        row.appendChild(val);
        wrap.appendChild(row);
      });
    }

    // ===== Range bar =====
    function renderRangeBar(minP, maxP) {
      const fill = document.getElementById("rangeFill");

      const metaLeft = document.getElementById("rangeMetaLeft");
      const metaRight = document.getElementById("rangeMetaRight");
      const minLabel = document.getElementById("rangeMinLabel");
      const maxLabel = document.getElementById("rangeMaxLabel");

      metaRight.textContent = `Scale: ${fmtUSD(RANGE_SCALE_MIN)} - ${fmtUSD(RANGE_SCALE_MAX)}`;
      minLabel.textContent = `Min: ${fmtUSD(minP)}`;
      maxLabel.textContent = `Max: ${fmtUSD(maxP)}`;

      if (minP == null || maxP == null || Number.isNaN(Number(minP)) || Number.isNaN(Number(maxP))) {
        fill.style.left = "0%";
        fill.style.width = "0%";
        metaLeft.textContent = "Range: x Undefined";
        return;
      }

      const mn = Math.max(RANGE_SCALE_MIN, Math.min(RANGE_SCALE_MAX, Number(minP)));
      const mx = Math.max(RANGE_SCALE_MIN, Math.min(RANGE_SCALE_MAX, Number(maxP)));
      const leftPct = ((mn - RANGE_SCALE_MIN) / (RANGE_SCALE_MAX - RANGE_SCALE_MIN)) * 100;
      const rightPct = ((mx - RANGE_SCALE_MIN) / (RANGE_SCALE_MAX - RANGE_SCALE_MIN)) * 100;
      const widthPct = Math.max(0, rightPct - leftPct);

      fill.style.left = leftPct.toFixed(1) + "%";
      fill.style.width = Math.max(1.5, widthPct).toFixed(1) + "%";

      metaLeft.textContent = `Range: ${fmtUSD(minP)} - ${fmtUSD(maxP)} (${fmtUSD(Number(maxP) - Number(minP))})`;
    }

    // ===== History (last 5) =====
    const HISTORY_LIMIT = 5;
    function loadHistory() {
      try {
        const raw = localStorage.getItem("demo_history_v2");
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function saveHistory(items) {
      localStorage.setItem("demo_history_v2", JSON.stringify(items.slice(0, HISTORY_LIMIT)));
    }
    function pushHistory(entry) {
      const items = loadHistory();
      items.unshift(entry);
      saveHistory(items);
      renderHistory();
    }
    function renderHistory() {
      const body = document.getElementById("historyBody");
      const items = loadHistory();
      if (!items.length) {
        body.innerHTML = '<tr><td class="smallMuted" colspan="4">No history yet.</td></tr>';
        return;
      }
      body.innerHTML = "";
      items.slice(0, HISTORY_LIMIT).forEach(it => {
        const tr = document.createElement("tr");

        const q = document.createElement("td");
        q.textContent = `${it.artist} · ${it.city}, ${it.state} · ${it.date || "N/A"}`;

        const p = document.createElement("td");
        p.textContent = fmtPct(it.probability);

        const mn = document.createElement("td");
        mn.textContent = fmtUSD(it.pred_min);

        const mx = document.createElement("td");
        mx.textContent = fmtUSD(it.pred_max);

        tr.appendChild(q); tr.appendChild(p); tr.appendChild(mn); tr.appendChild(mx);
        body.appendChild(tr);
      });
    }

    // ===== Output =====
    function setOutput(out) {
      document.getElementById("prob").textContent = fmtPct(out.probability);
      document.getElementById("pmin").textContent = fmtUSD(out.pred_min);
      document.getElementById("pmax").textContent = fmtUSD(out.pred_max);

      const prob = out.probability ?? 0;
      document.getElementById("probHint").textContent =
        prob >= 0.65 ? "High likelihood" : prob >= 0.40 ? "Medium likelihood" : "Low likelihood";

      const spread = (out.pred_max != null && out.pred_min != null) ? Math.max(0, out.pred_max - out.pred_min) : null;
      document.getElementById("rangeHint").textContent = spread != null ? `Range width: ${fmtUSD(spread)}` : "";
      document.getElementById("maxHint").textContent = out.note || "";

      renderFeatureBars(out.top_features || []);
      renderRangeBar(out.pred_min, out.pred_max);
    }

    // ===== Local fallback engine =====
    function localEngine(payload) {
      const cityKey = payload.city.toLowerCase();
      const majorCity = ["new york","los angeles","san francisco","chicago","boston","seattle","miami","austin","dallas","houston"].includes(cityKey);

      const nameSignal = (payload.artist.length % 17) / 16; // 0..1
      const genre = (payload.genre || "").toLowerCase();
      const genreBoost =
        genre.includes("pop") ? 0.18 :
        (genre.includes("hip") || genre.includes("rap")) ? 0.20 :
        genre.includes("rock") ? 0.14 :
        genre.includes("country") ? 0.10 :
        genre.includes("jazz") ? 0.07 :
        genre.includes("new age") ? 0.05 :
        0.09;

      let weekendBoost = 0.0;
      let monthBoost = 0.0;
      let weekdayName = "N/A";
      if (payload.date) {
        const d = new Date(payload.date + "T00:00:00");
        const day = d.getDay(); // 0..6
        const month = d.getMonth() + 1; // 1..12
        weekdayName = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][day];
        weekendBoost = (day === 0 || day === 6) ? 0.10 : 0.0;
        monthBoost = ([6,7,8,12].includes(month)) ? 0.06 : 0.0;
      }

      const cityBoost = majorCity ? 0.12 : 0.02;
      const prob = clamp01(0.22 + 0.42 * nameSignal + genreBoost + cityBoost + weekendBoost + monthBoost);

      const base =
        genre.includes("pop") ? 78 :
        (genre.includes("hip") || genre.includes("rap")) ? 85 :
        genre.includes("rock") ? 70 :
        genre.includes("country") ? 62 :
        genre.includes("jazz") ? 55 :
        genre.includes("new age") ? 50 :
        60;

      const minPrice = Math.max(25, base + 55 * (prob - 0.30) + (majorCity ? 8 : 0));
      const maxPrice = Math.max(minPrice, minPrice + 35 + 150 * prob + (majorCity ? 15 : 0));

      const feats = [
        { name: "Artist popularity (proxy)", score: 0.35 + 0.45 * nameSignal },
        { name: "Genre effect", score: 0.20 + genreBoost },
        { name: "City market size", score: 0.18 + (majorCity ? 0.10 : 0.02) },
        { name: "Weekend / weekday", score: 0.10 + weekendBoost },
        { name: "Seasonality (month)", score: 0.08 + monthBoost },
        { name: "State baseline", score: 0.06 + (payload.state ? (payload.state.charCodeAt(0) % 10) / 50 : 0) },
      ].sort((a,b)=>b.score-a.score);

      return {
        probability: prob,
        pred_min: Math.round(minPrice),
        pred_max: Math.round(maxPrice),
        top_features: feats,
        note: `Day: ${weekdayName}`
      };
    }

    async function callBackend(payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`);
      return await res.json();
    }

    async function predict(payload) {
      try {
        console.log("🌐 Calling real backend API:", API_URL);
        const result = await callBackend(payload);
        console.log("✅ Backend response received:", result);
        return result;
      } catch (e) {
        console.warn("⚠️ Backend call failed:", e.message);
        if (!ALWAYS_FALLBACK_TO_LOCAL) throw e;
        console.log("🔄 Using local fallback engine");
        return localEngine(payload);
      }
    }

    async function onPredict() {
      setLoading(true);
      try {
        const payload = getInputs();
        setLog("Running inference...");
        const out = await predict(payload);

        setOutput(out);

        pushHistory({
          artist: payload.artist,
          city: payload.city,
          state: payload.state,
          date: payload.date,
          probability: out.probability,
          pred_min: out.pred_min,
          pred_max: out.pred_max
        });

        setLog("Prediction complete.");
      } catch (err) {
        setLog("Error: " + (err?.message || String(err)));
      } finally {
        setLoading(false);
      }
    }

    // ===== Init =====
    (function init() {
      const el = document.getElementById("date");
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      el.value = `${yyyy}-${mm}-${dd}`;

      renderPresets();
      renderHistory();
      renderRangeBar(null, null);
      setLoading(false);
    })();
  </script>
</body>
</html>


